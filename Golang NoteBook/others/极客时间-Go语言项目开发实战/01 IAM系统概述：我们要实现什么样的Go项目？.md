

## 项目背景：为什么使用IAM系统作为实战项目？


我们在做Go项目的时候，如何保证Go应用的安全，是每个开发者都要解决的问题。虽然Go应用的安全包含很多方面，但大体可分为如下2类：

- 服务自身的安全：为了保证服务的安全，需要禁止非法用户访问服务。这可以通过服务器和软件层面来解决。服务器层面可以通过物理隔离、网络隔离、防火墙隔离等技术从底层保证服务的安全性，软件层面一般由运维团队来保障，软件层面需要开发者来保障。
- 服务资源的安全：服务内很多资源，为了避免非法访问，开发者要避免UserA访问到UserB的资源，也即需要对资源进行授权。通常，我们可以通过资源授权系统来对资源进行授权。


总的来说，为了保障Go应用的安全，我们需要对访问进行认证，对资源进行授权。

认证功能不复杂，我们可以通过JWT（JSON Web Token）认证来实现。授权功能比较复杂，授权功能的复杂性使得它可以囊括很多Go开发技能点。因此，在这个专栏中，将认证和授权的功能实现升级为IAM系统，通过讲解它的构建过程，来讲清楚Go项目开发的全部流程。


## IAM 系统是什么？

IAM（Identity and Access Management， 身份识别与访问管理）系统是用Go语言编写的一个Web服务，用于给第三方用户提供访问控制服务。

IAM系统可以帮助用户解决的问题是：在特定条件下，谁能够/不能够对哪些资源做哪些操作（Who is able to do what on something given some context），也即完成资源的授权功能。

IAM系统的资源授权过程可以分为4步。
- 1 用户需要提供昵称、密码、邮箱、电话等信息注册并登录到IAM系统，这里是以用户名和密码作为唯一的身份标识来访问IAM系统，并且完成认证。
- 2 因为访问IAM的资源授权接口是通过密钥（secretID/secretKey）的方式进行认证的，所以用户需要在IAM中创建属于自己的密钥资源。 
- 3 因为IAM资源是通过授权策略完成授权，所以需要在IAM中创建授权策略。
- 4 请求IAM提供的授权接口，IAM会根据用户的请求内容和授权策略来决定一个授权请求是否被允许。

可以看到，在上面的流程中，IAM使用到了3种系统资源：用户（User）、密钥（Secret）和策略（Policy），它们映射到程序设计中就是3种RESTful资源：
- 用户（User）
- 密钥（Secret）
- 策略（Policy）


总的来说，IAM架构包括9大组件和3大数据库。我将这些组件和功能都总结在下面的表格中。这里面，我们记住5个核心组件，包括iam-apiserver、iam-authz-server、iam-pump、marmotedu-sdk-go和iamctl的功能，还有3个数据库Redis、MySQL和MongoDB的功能。

- Redis：缓存数据库，用来缓存密钥和授权策略，降低访问延时，同时也会缓存授权日志作为运营系统的数据来源。 
- 持久性存储用户、密钥和授权策略信息
- MongoDB：存储授权日志，供后期运营系统展示和分析


## 通过使用流程来理解架构





## 总结

一个好的Go应用必须保证应用的安全性，这可以通过认证和授权来保障。也因此认证和授权是开发一个Go项目必须要实现的功能。为了帮助你实现这两个功能，并借此机会学习Go项目开发，我将这2个功能升级为一个IAM系统。

首先，用户通过iam-apiserver提供的RESTful API接口完成注册和登录系统，再调用接口创建密钥和授权策略。

创建完密钥对和授权策略之后，IAM可以通过调用iam-authz-server的授权接口完成资源的授权。具体来说，iam-authz-server通过gRPC接口获取iam-apiserver中存储的密钥和授权策略信息，通过JWT完成认证之后，再通过[ory/ladon]()包完成资源的授权。

最后，IAM相关的产品、研发人员可以通过IAM的运营系统iam-operating-system来查看IAM系统的使用情况，进行运营分析。例如某个用户的授权/失败次数、授权失败时的授权信息等。

另外，为了提高开发和访问效率，IAM分别提供了marmotedu-sdk-go SDK和iamctl命令行工具，二者通过HTTPS协议访问IAM提供的RESTful接口。